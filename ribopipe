#!/bin/bash +x
#set -e # script dies if anything exits in error.
set -o errtrace
set -o nounset
# --------------------------------- USAGE -----------------------------------

# ./ribopipe.sh <directory> <database> <shannon-reads>

# - Directory contains reads
# - Database is a TaxCollector database in FASTA format
# - Shannon-reads is the number of reads to use to calculate the
#     Shannon Diversity Index

# ------------------------------ CONFIGURATION ------------------------------

# So you can manually specify which python/perl you want to use.
python=$(which python)
perl=$(which perl)
cores='16'

assemble="./src/clc/clc_ref_assemble_long"
filter="./src/clc/filter_matches"
make_tables="./src/clc/assembly_table"
count_phyl="$python src/phylo_count.py"
megaclustable="$perl src/megaclustable.pl"
pre_shannon="$python src/preshannon.py"
shannon="$perl src/shannon.pl"
unassembled_reads="src/clc/unassembled_reads"
label_fasta="python src/label_fasta.py"
cdhit="src/cdhit/cd-hit-est"
cdhit_overhang="78"

# To get number of cores automatically, uncomment:
#cores=`system_profiler|head -n 10|grep Total\ Number\ Of\ Cores | cut -d ':' -f 2`

# ---------------------------------------------------------------------------

dir=$1 # working directory
reads=$1/reads # where the reads are at
clc_out=$1/clc_out # where CLC's output goes
tables=$1/tables # where the tables go
database=$2 # the RDP database
shannon_reads=$3 # number of reads for Shannon-Diversity Index
run=$4 # This gets added to the headers of the unmatched reads (ugly patch)
unassembled=$1/reads/unassembled # Where unassembled reads are kept
logfile=$dir/log.txt

# ---------------------------------------------------------------------------

main () {
  title "$(date)"
  status "DIR = $dir"
  status "READS = $reads"
  status "RUN = $run"
  status "CLC_OUT = $clc_out"
  status "TABLES = $tables"
  status "DATABASE = $database"
  status "SHANNON_READS = $shannon_reads"
  status "CORES = $cores"
  status "LOGFILE = $logfile"
  
  mkdir -p $clc_out
  mkdir -p $tables
  mkdir -p $unassembled
  
#  reference_assemble
  
#  filter
  
#  generate_tables
  
#  separate_unassembled
  
  cluster_unassembled
  
#  count_phylogenies $tables  
  
#  make_megaclustables $tables $dir
  
#  run_shannon # on clustered reads!
  
  title "$(date)."
  
  onexit
}

reference_assemble () { 
  title "Assembling $reads against $database"

  for file in $reads/*.txt
  do
    status "Assembling $(basename $file) against $database"
    $assemble -o "$clc_out/$(basename $file).out" \
      -r random \
      -a global \
      -q -p fb ss 0 500 "$file" \
      -d $database \
      -l 0.5 \
      -s 0.8
  done
}

filter () {
  title "Filtering with $filter"
  for sim in 80 90 95 99
  do
    for file in $clc_out/*.out
    do     
      mkdir -p $clc_out/L_98_S_$sim
      status "Filtering $(basename $file) @ $sim%"
      $filter -a $file \
         -l 0.98 \
         -s .$sim \
         -o $clc_out/L_98_S_$sim/$(basename $file).filtered 
    done
  done
}

generate_tables() {
  title "Generating tables with $make_tables"
  for sim in 80 90 95 99
  do
    for file in $clc_out/L_98_S_$sim/*.filtered
    do
      status "$(basename $file) => $sim%"
      # Generate tables for each percent similarity
      mkdir -p $tables/L_98_S_$sim
      $make_tables -n -p -s $file > $tables/L_98_S_$sim/$(basename $file).table
    done
  done
}

separate_unassembled() {
  title "Separating/labelling unassembled reads"
  for sim in 80 90 95 99
  do
    for file in $clc_out/L_98_S_$sim/*.filtered
    do
      status "Separating $(basename $file) @ $sim%"
      # Output unassembled reads for each percent similarity
      rm -f $unassembled/L_98_S_$sim/$(basename $file).fa # CLC appends :\
      
      mkdir -p $unassembled/L_98_S_$sim
      $unassembled_reads \
         -p \
         -a $file \
         -o $unassembled/L_98_S_$sim/$(basename $file).fa
      
      status "Labelling $(basename $file) (run: $run)"
      
      # Concatenate unassembled reads while adding ids to header
      # Reads have to go together a certain way to be clustered
      # 5'-read1-3' + 3'-read2-5'
      rm -f $unassembled/unassembled_"$sim".fa # Clean
      $label_fasta \
        $unassembled/L_98_S_$sim/$(basename $file).fa \
        $run \
        >> $unassembled/unassembled_"$sim".fa
    done
  done
}

cluster_unassembled() {
  title "Clustering unassembled reads with $cdhit"
  status "Overhang = $cdhit_overhang"
  for sim in 80 90 95 99
  do
    status "Clustering @ $sim% yielded " \ 
      "`grep -c '^>' $unassembled/clustered_$sim.fa` clusters"
    input=$unassembled/unassembled_$sim.fa
    output=$unassembled/clustered_$sim.fa
    
    $cdhit \
      -i $input \
      -o $output \
      -c 0.$sim \
      -n 8 \
      -T $cores \
      -s 0.$cdhit_overhang \
      -g 1 > /dev/null
  done
}

count_phylogenies () {
  title "Summing up phylogenies with $count_phyl"
  table_dir=$1
  
  for sim in 80 90 95 99
  do
    for file in $table_dir/L_98_S_$sim/*.table
    do
      status "Counting $(basename $file) @ $sim%"
      $count_phyl $database $file
      cat $file.paired.out $file.unpaired.out > $file.both.out
     done
  done
}

make_megaclustables () {
  title "Megaclustableing with $megaclustable"
  table_dir=$1
  out_dir=$2
  
  megaclustable 99 6 species
  megaclustable 95 5 genus
  megaclustable 90 4 family
  megaclustable 90 3 order
  megaclustable 90 2 class
  megaclustable 80 1 phylum
  megaclustable 80 0 domain
}

megaclustable() {
    sim=$1
    t=$2
    out=$3
    
    status "Megaclustable $out: $sim%, t=$t"
    $megaclustable \
      -m $(ls -m $table_dir/L_98_S_$sim/*.both.* | tr -d ',\n') \
      -t $t \
      -o $out_dir/$out.txt  
}

run_shannon () {
  title "Shannon Diversity Indexing"

  mkdir -p $tables/shannon/
  for sim in 80 90 95 99
  do
    mkdir -p $tables/shannon/L_98_S_$sim
    # Make files
    for file in $tables/L_98_S_$sim/*.table
    do
      $pre_shannon $shannon_reads $file $tables/shannon/L_98_S_$sim/$(basename $file)
    done    
  done
  
  # Run Phylocount
  count_phylogenies "$tables/shannon"    
  
  # Run Megaclustable
  make_megaclustables "$tables/shannon" "$tables/shannon/"
  
  # Run shannon.pl on our standardized tables
  for filename in $tables/shannon/*.txt
  do
    $shannon -t $filename >> $filename
  done
}

title () {
  purple="\033[0;35m"
  nocolor="\033[0m"
  c="$purple>>>$nocolor"
  d=">>>"
  echo -e $c $1
  echo $d $1 >> $logfile
}

status () {
  green="\033[0;36m"
  nocolor="\033[0m"
  c="[$green*$nocolor]" 
  d="[*]"
  echo -e $c $1
  echo $d $1 >> $logfile
}

onexit() {
  red="\033[0;31m"
  nocolor="\033[0m"
  c="[$red*$nocolor]" 
  d="[*]"
  exit_status=${1:-$?}
  m="Exiting $0 with $exit_status"
  echo -e $c $m
  echo $d $m >> $logfile
  exit $exit_status
}

trap onexit 1 2 3 15 ERR
main